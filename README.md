# MINKE's Indexed Ni-Zhan Keypoint Environment

**MINKE 地图数据化引擎** 是一款基于 Rust (egui) 开发的、专为《逆战：未来》塔防模式设计的次世代地图数据化工具。它是 **MINKE 硬件自动化生态 (ESP32-S3)** 的核心数据生成端。

本工具旨在将感性的“游戏截图”转化为极其精确的、可被机器索引的 **纯数字环境数据 (JSON)**，彻底打通从“视觉图纸”到“物理按键”的最后一公里。

> 💬 **加入开发讨论**: 1075480881

---

## 🌟 核心特性 (Features)

* **🗺️ 纯净的图物分离架构**：静态地形与动态建筑解耦。地图数据仅记录“地形蒙版”与“海拔高度”，极大压缩数据体积。
* **🎯 浮点数级校准 (Float32 Calibration)**：采用浮点数记录网格大小与偏移量，彻底根除 UI 缩放与分辨率变化带来的累积误差，确保自动化点击精准落入网格中心。
* **🔍 无限工作台 (Infinite Canvas)**：基于摄像机矩阵算法，支持平滑的无限拖拽与以鼠标为中心的无损缩放 (10% - 1000%)。
* **⛰️ 高度映射笔刷 (Elevation Brush)**：类似《我的世界》的操作体验。使用红/绿/黄/蓝/紫五色笔刷，直接在平面底图上绘制出三维的地形高度信息。
* **📈 动态内存伸缩**：实时调整地图网格维度 (Rows x Cols)，底层数据安全扩容。

---

## 🚀 快速开始 (Getting Started)

### 1. 环境准备
确保已安装 [Rust Toolchain](https://www.rust-lang.org/tools/install)。

### 2. 准备底图
**关键步骤**：请截取一张游戏内的地图全景图（建议 1920x1080 原图），将其重命名为 `1.png`，并放置在项目的**根目录**下。

> 程序启动时会自动加载根目录下的 `1.png` 作为背景参考。

### 3. 启动引擎
```bash
git clone [https://github.com/Minkelxy/MINKE-s-Indexed-NiZhan-Keypoint-Environment.git](https://github.com/Minkelxy/MINKE-s-Indexed-NiZhan-Keypoint-Environment.git)
cd MINKE-s-Indexed-NiZhan-Keypoint-Environment
cargo run --release

```

---

## 🎮 操作指南 (User Guide)

本工具的操作逻辑遵循 **“对齐 -> 绘制 -> 导出”** 的标准工作流。

### 🕹️ 快捷键速查表 (Controls)

| 操作 | 输入方式 | 说明 |
| --- | --- | --- |
| **平移视图** | `鼠标中键` 按住拖动 | 在无限画布上移动视野 |
| **缩放视图** | `鼠标滚轮` 滚动 | 以光标为中心进行缩放 |
| **绘制地形** | `鼠标左键` 点击/拖动 | 使用当前选中的笔刷上色 |
| **快速擦除** | `鼠标右键` 点击/拖动 | 将区域重置为“平地 (0)”或清除状态 |

### 🛠️ 详细工作流

#### 第一步：网格校准 (Calibration)

启动后，你会看到绿色的网格覆盖在地图上。你需要调整左侧面板的参数，使网格与游戏地图完美重合。

1. **Grid Size (网格大小)**：调整单个格子的大小（支持浮点微调）。
2. **Origin X / Y (原点坐标)**：调整网格左上角的起始位置。
3. **Rows / Cols (行列数)**：根据地图实际大小，增加或减少覆盖范围。

> **技巧**：先找准地图左上角的第一个格子对齐原点，然后调整 Grid Size 直到最右下角的格子也完美对齐。

#### 第二步：地形绘制 (Painting)

在左侧面板选择 **画笔工具 (Brush Tool)**，对地图进行语义化标记。不同的颜色代表不同的物理含义：

* 🔴 **障碍物 (ID: -1)**
* **含义**：不可放置陷阱的区域（如深渊、墙体内部、出怪口红线内）。
* **作用**：自动化脚本在寻路时会强制避开这些网格。


* 🟢 **基础平地 (ID: 0)**
* **含义**：最常见的地面，默认可放置陷阱。


* 🟡 **一级高台 (ID: 1)**
* **含义**：游戏视觉中的“矮墙”或“低高台”。


* 🔵 **二级高台 (ID: 2)**
* **含义**：标准墙面或中等高度高台。


* 🟣 **三级高台 (ID: 3)**
* **含义**：天花板或极高处（对应放置防空/天花板陷阱的位置）。



#### 第三步：数据导出 (Export)

绘制完成后，点击左下角的 **Export JSON** 按钮。
程序会在当前目录下生成 `minke_map_data.json`。请将此文件复制到您的自动化驱动项目中。

---

## 📦 输出数据规范 (Output Spec)

导出的 JSON 专为机器读取优化，去除了所有冗余信息：

```json
{
  "map_name": "Ni-Zhan_Exported_Map",
  "meta": {
    "grid_pixel_size": 32.5,   // 亚像素级精度
    "offset_x": 12.0,
    "offset_y": 5.0
  },
  "layers": [
    {
      "major_z": 0,
      "name": "Major_Layer_0",
      // 地形矩阵: [行][列]
      // -1: 障碍, 0: 平地, >0: 高台
      "elevation_grid": [
        [0, 0, -1, -1],
        [0, 1,  1, -1] 
      ]
    }
  ]
}

```

---

## 🔗 生态集成 (Ecosystem)

本工具是 **MINKE** 自动化流水线的上游：

1. **Map Editor (本工具)**：生成 `.json` 地形数据。
2. **[NZM_CMD](https://www.google.com/search?q=https://github.com/Minkelxy/NZM_CMD)** (执行端)：
* 读取 JSON，结合 A* 算法规划路径。
* 生成符合人类手部特征的贝塞尔曲线轨迹。
* 通过串口指令驱动硬件。


3. **Hardware (ESP32-S3)**：接收指令，物理模拟键鼠操作。

---

*“用数据重构战场，以代码掌控未来。”*
